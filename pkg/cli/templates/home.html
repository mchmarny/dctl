{{ define "home" }}

{{ template "header" . }}

<!-- Middle  -->

    <input type="hidden" id="period_months" value="{{ .period_months }}" />
    <input type="hidden" id="default_months" value="{{ .period_months }}" />

    {{ if .err }}
        <div class="error">
            <p><b>Error:</b> {{ .err }}</p>
        </div>
    {{ end }}

    <section class="search-and-user">
        <form id="home-search-form">
            <input type="search" placeholder="org:name, repo:name, or entity:name" id="search-bar" autocomplete="off">
            <button type="submit" aria-label="submit form">
                <svg aria-hidden="true">
                    <use xlink:href="#search"></use>
                </svg>
            </button>
            <div id="ac-dropdown" class="ac-dropdown"></div>
        </form>
        <button class="theme-toggle-btn" id="theme-toggle" aria-label="toggle theme">
            <svg class="icon-moon" aria-hidden="true">
                <use xlink:href="#moon"></use>
            </svg>
            <svg class="icon-sun" aria-hidden="true">
                <use xlink:href="#sun"></use>
            </svg>
        </button>
    </section>

    <div class="search-meta">
        <b class="header-term">All imported events</b> over the last
        <select id="period-select">
            <option value="{{ .period_months }}">{{ .period_months }} months</option>
        </select>
    </div>
    
    <section class="grid">
        <article>
            <div class="tbl">
                <div class="content-header">
                    Project Health
                </div>
                <div class="tbl-chart tbl-home insights-summary">
                    <div class="insight-card">
                        <span class="insight-label">Bus Factor</span>
                        <span class="insight-val" id="bus-factor-val">—</span>
                        <span class="insight-desc">Developers who account for >=50% of all work (lower number means higher risk if they leave)</span>
                    </div>
                    <div class="insight-card">
                        <span class="insight-label">Pony Factor</span>
                        <span class="insight-val" id="pony-factor-val">—</span>
                        <span class="insight-desc">Organizations behind >=50% of all work (lower means higher dependency on fewer companies)</span>
                    </div>
                </div>
            </div>
        </article>
        <article>
            <div class="tbl">
                <div class="content-header">
                    Monthly Activity
                </div>
                <div class="tbl-chart tbl-home">
                    <canvas class="chart" id="time-series-chart"></canvas>
                </div>
                <span class="insight-desc">GitHub events (PRs, issues, reviews, comments, forks) grouped by month. Trend line is linear regression.</span>
            </div>
        </article>
        <article>
            <div class="tbl">
                <div class="content-header">
                    Contributor Retention
                </div>
                <div class="tbl-chart tbl-home">
                    <canvas class="chart" id="retention-chart"></canvas>
                </div>
                <span class="insight-desc">New = first contribution that month. Returning = contributed in a prior month.</span>
            </div>
        </article>
        <article>
            <div class="tbl" style="position:relative;">
                <div class="content-header">
                    Lowest Reputation Contributors
                </div>
                <div class="tbl-chart tbl-home">
                    <canvas class="chart" id="reputation-chart"></canvas>
                </div>
                <span class="insight-desc">Shallow score (local data only). Click a bar for full GitHub-enriched score.</span>
                <div id="reputation-popover" class="entity-popover">
                    <div class="entity-popover-header">
                        <span id="reputation-popover-title"></span>
                        <button id="reputation-popover-close" class="modal-close">&times;</button>
                    </div>
                    <ul id="reputation-popover-list"></ul>
                </div>
            </div>
        </article>
        <article>
            <div class="tbl" style="position:relative;">
                <div class="content-header">
                    Top Entities (Company or Org)
                </div>
                <div class="tbl-chart tbl-home">
                    <canvas class="chart" id="left-chart"></canvas>
                </div>
                <span class="insight-desc">Based on GitHub profile company field and CNCF gitdm affiliations. Self-reported, not verified.</span>
                <div id="entity-popover" class="entity-popover">
                    <div class="entity-popover-header">
                        <span id="entity-popover-title"></span>
                        <button id="entity-popover-close" class="modal-close">&times;</button>
                    </div>
                    <ul id="entity-popover-list"></ul>
                </div>
            </div>
        </article>
        <article>
            <div class="tbl">
                <div class="tbl-header">
                     <div class="content-header">
                        Top Colaborators
                    </div>
                </div>
                <div class="tbl-content tbl-home">
                    <canvas class="chart" id="right-chart"></canvas>
                </div>
                <span class="insight-desc">Ranked by total event count (PRs, issues, reviews, comments) in the selected period.</span>
            </div>
        </article>
        <article>
            <div class="tbl">
                <div class="content-header">
                    PR Review Ratio
                </div>
                <div class="tbl-chart tbl-home">
                    <canvas class="chart" id="pr-ratio-chart"></canvas>
                </div>
                <span class="insight-desc">Reviews per PR. Higher ratio suggests stronger code review culture.</span>
            </div>
        </article>
        <article>
            <div class="tbl">
                <div class="content-header">
                    Time to Merge (PRs)
                </div>
                <div class="tbl-chart tbl-home">
                    <canvas class="chart" id="time-to-merge-chart"></canvas>
                </div>
                <span class="insight-desc">Average days from PR open to merge. Based on GitHub created/merged timestamps.</span>
            </div>
        </article>
        <article>
            <div class="tbl">
                <div class="content-header">
                    Time to Close (Issues)
                </div>
                <div class="tbl-chart tbl-home">
                    <canvas class="chart" id="time-to-close-chart"></canvas>
                </div>
                <span class="insight-desc">Average days from issue open to close. Based on GitHub created/closed timestamps.</span>
            </div>
        </article>
        <article>
            <div class="tbl">
                <div class="content-header">
                    Release Cadence
                </div>
                <div class="tbl-chart tbl-home">
                    <canvas class="chart" id="release-cadence-chart"></canvas>
                </div>
                <span class="insight-desc">GitHub releases per month. Stable excludes pre-releases and drafts.</span>
            </div>
        </article>
        <article>
            <div class="tbl">
                <div class="content-header">
                    Repository Metadata
                </div>
                <div class="tbl-chart tbl-home insights-grid" id="repo-meta-container">
                    <span class="insight-label">No metadata imported yet</span>
                </div>
                <span class="insight-desc">Snapshot from GitHub API at last import. Stars, forks, and issues may lag.</span>
            </div>
        </article>

        <article>
            <div class="tbl bordered">
                <div class="tbl-header">
                    <div class="content-header">
                        Event Search
                    </div>
                </div>
                <div class="tbl-content">
                    <form id="search-filters" class="search-filters">
                        <div class="filter-row">
                            <label for="filter-type">Type</label>
                            <select id="filter-type">
                                <option value="">All</option>
                                <option value="PR">PR</option>
                                <option value="PR-Review">PR-Review</option>
                                <option value="Issue">Issue</option>
                                <option value="Issue-Comment">Issue-Comment</option>
                                <option value="Fork">Fork</option>
                            </select>
                        </div>
                        <div class="filter-row">
                            <label for="filter-from">From</label>
                            <input type="date" id="filter-from" />
                        </div>
                        <div class="filter-row">
                            <label for="filter-to">To</label>
                            <input type="date" id="filter-to" />
                        </div>
                        <div class="filter-row">
                            <label for="filter-user">User</label>
                            <input type="text" id="filter-user" placeholder="username" />
                        </div>
                        <div class="filter-row">
                            <label for="filter-entity">Entity</label>
                            <input type="text" id="filter-entity" placeholder="company" />
                        </div>
                        <div class="filter-actions">
                            <button type="submit" class="modal-btn modal-btn-primary">Search</button>
                            <button type="button" id="filter-clear" class="modal-btn">Clear</button>
                        </div>
                    </form>
                    <div id="search-results-wrap" style="display:none;">
                        <div id="tbl-criteria"></div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Repo</th>
                                    <th>Event Type</th>
                                    <th>Developer</th>
                                    <th>Entity</th>
                                </tr>
                            </thead>
                            <tbody id="result-table-content"></tbody>
                        </table>
                        <div class="result-pager">
                            Page <b id="page-number">1</b>
                            &nbsp;
                            <a href="#" id="prev-page">Prev</a> |
                            <a href="#" id="next-page">Next</a>
                        </div>
                    </div>
                </div>
            </div>
        </article>

    </section>

<!-- End Middle  -->

{{ template "footer" . }}

{{ end }}